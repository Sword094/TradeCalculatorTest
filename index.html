<div id="trade-calculator" style="font-family: 'Funnel Display', sans-serif;">
  <div class="trade-container">
    <div class="player-section" id="player-a">
      <h2>Player A</h2>
      <div class="pet-grid" id="grid-a"></div>
      <div class="summary">
        <button onclick="resetPlayer('a')">Reset</button>
        <span>Total: <span id="total-a">0</span></span>
      </div>
    </div>

    <div class="player-section" id="player-b">
      <h2>Player B</h2>
      <div class="pet-grid" id="grid-b"></div>
      <div class="summary">
        <button onclick="resetPlayer('b')">Reset</button>
        <span>Total: <span id="total-b">0</span></span>
      </div>
    </div>
  </div>

  <div id="pet-modal" class="modal">
    <div class="modal-content">
      <button onclick="closeModal()" style="float:right">Close</button>
      <input type="text" id="pet-search" placeholder="Search pets..." />
      <div id="pet-options"></div>
    </div>
  </div>
</div>

<style>
/* Same styling as before */
</style>

<script>
const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTTVLqYuKsAvkMYA5ay7sv_4dc2OkayDHGq3j-UhLUM3M7PbPpMrZ_iYfM2RUP5wGVPbjuyKaQeCduG/pub?output=csv";
const petImageMap = {
  "Dog": {
    "Normal": "https://example.com/dog.png",
    "Shiny": "https://example.com/dog-shiny.png",
    "Mythic": "https://example.com/dog-mythic.png",
    "Shiny Mythic": "https://example.com/dog-shiny-mythic.png"
  },
  "Cat": {
    "Normal": "https://example.com/cat.png",
    "Shiny": "https://example.com/cat-shiny.png",
    "Mythic": "https://example.com/cat-mythic.png",
    "Shiny Mythic": "https://example.com/cat-shiny-mythic.png"
  }
};

let pets = [];
let activeBox = null;

function fetchSheetData() {
  fetch(sheetUrl)
    .then(res => res.text())
    .then(csv => {
      const rows = csv.split("\n").slice(1);
      pets = rows.map(row => {
        const cols = row.split(",");
        const name = cols[0]?.trim();
        return {
          name,
          variants: {
            "Normal": parseFloat(cols[1]) || 0,
            "Shiny": parseFloat(cols[2]) || 0,
            "Mythic": parseFloat(cols[3]) || 0,
            "Shiny Mythic": parseFloat(cols[4]) || 0
          }
        };
      });
      buildPetGrids();
    });
}

function buildPetGrids() {
  ['a', 'b'].forEach(side => {
    const grid = document.getElementById(`grid-${side}`);
    for (let i = 0; i < 10; i++) {
      const box = document.createElement("div");
      box.className = "pet-slot";
      box.innerHTML = `<span class="pet-name">+</span>`;
      box.addEventListener('click', e => {
        if (!e.target.classList.contains('remove-btn')) openModal(box, side);
      });
      grid.appendChild(box);
    }
  });
}

function openModal(box, side) {
  activeBox = box;
  document.getElementById("pet-modal").style.display = "block";
  populateModal();
}

function closeModal() {
  document.getElementById("pet-modal").style.display = "none";
  document.getElementById("pet-search").value = "";
}

function populateModal() {
  const container = document.getElementById("pet-options");
  const query = document.getElementById("pet-search").value.toLowerCase();
  container.innerHTML = "";
  pets.filter(p => p.name.toLowerCase().includes(query)).forEach(pet => {
    Object.entries(pet.variants).forEach(([variant, value]) => {
      const div = document.createElement("div");
      div.className = "pet-option";
      const imageUrl = petImageMap[pet.name]?.[variant] || "";
      div.innerHTML = `
        <div><img src="${imageUrl}" style="width:60px;"><br><strong>${pet.name}</strong> (${variant})</div>
        <div>${value}</div>
      `;
      div.onclick = () => selectPet(pet.name, variant, value, imageUrl);
      container.appendChild(div);
    });
  });
}

function selectPet(name, variant, value, imageUrl) {
  if (!activeBox) return;
  activeBox.innerHTML = `
    <div class="pet-name">${name} <small>${variant}</small><br><small>${value}</small></div>
    ${imageUrl ? `<img src="${imageUrl}" style="width:60px;">` : ''}
    <button class="remove-btn" onclick="removePet(this)">âœ–</button>
  `;
  activeBox.setAttribute("data-value", value);
  updateTotals();
  closeModal();
}

function removePet(btn) {
  const box = btn.closest(".pet-slot");
  box.innerHTML = `<span class="pet-name">+</span>`;
  box.removeAttribute("data-value");
  updateTotals();
}

function resetPlayer(side) {
  const grid = document.getElementById(`grid-${side}`);
  grid.querySelectorAll(".pet-slot").forEach(slot => {
    slot.innerHTML = `<span class="pet-name">+</span>`;
    slot.removeAttribute("data-value");
  });
  updateTotals();
}

function updateTotals() {
  ['a', 'b'].forEach(side => {
    const grid = document.getElementById(`grid-${side}`);
    let total = 0;
    grid.querySelectorAll(".pet-slot").forEach(slot => {
      const val = parseFloat(slot.getAttribute("data-value"));
      if (!isNaN(val)) total += val;
    });
    document.getElementById(`total-${side}`).textContent = total;
  });
}

document.getElementById("pet-search").addEventListener("input", populateModal);
window.onclick = e => {
  if (e.target == document.getElementById("pet-modal")) closeModal();
};

fetchSheetData();
</script>
